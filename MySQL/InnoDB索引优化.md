# InnoDB索引优化

## MySQL架构

### MySQL逻辑框架

![image-20200429085722788](C:%5CUsers%5Cheihei%5CDesktop%5CTypora%5C%E5%AD%A6%E4%B9%A0%5C%E7%8E%8B%E9%81%93%5CMySQL%5Cimage-20200429085722788.png)

大体来说，MySQL可以分为Server层和存储引擎层

- **Server层**包括连接器、查询缓存、解析器、优化器和执行器等，涵盖了MySQL大多数核心服务功能
- **存储引擎层**负责数据的存储和提取，其架构模式是插件式的，支持InnoDB、MyISAM、Memory等多个存储引擎

### MySQL是如何工作的？

- **连接器**

  连接器的作用就是和客户端建立连接、获取权限、维持和管理连接

  当你在客户端输入`mysql -u $user -p $pwd`连接`mysql`的时候，接待你的就是连接器

  - 注意

    因为权限获取是在建立连接的时候，所以在使用MySQL的过程中如果权限发生更改，不会立即生效，在下次建立连接的时候才会变更

    连接超过一定时间会自动断开

    ```mysql
    # 查看默认的等待时间
    select @@wait_timeout; # 默认为28000(8h)
    ```

    

- **查询缓存**

  建立连接之后，就可以执行`select`语句了。首先MySQL会去查看查询缓存，看一下之前是否已经执行过这条查询语句。如果命中缓存，就直接返回。否则就扔给解析器。

  底层是哈希表，key是 SQL语句，value是结果集

  - 注意

    逻辑上查询缓存可以提高访问效率，但是不推荐使用，这是为什么？

    因为只有数据表更新了，查询缓存中的所有相关数据就失效了，而大多数时候，数据都会更新，因此查询缓存并不能很好的提高查询效率。

    现在默认情况下，查询缓存是关闭的

    ```mysql
    # 查看存储缓存的状态
    select @@query_cache_type; # 默认是off
    ```

    

- **解析器**

  作用是告诉MySQL你想做什么，解析器会做词法分析和语法分析

  词法分析：分析每个词的含义

  语法分析：判断SQL语句是否满足SQL语法

- **优化器**

  优化器会优化你的SQL语句，生成MySQL认为的最优的最终执行方案(execution plan)

- **执行器**

  执行器首先会判断你对这张表有没有相应的权限。如果没有，就报错。如果有，就调用相应的存储引擎接口，执行语句，然后将结果集返回给客户端

## 存储引擎

### 概述

数据的存储和提取是由存储引擎负责的，它负责和文件系统打交道

MySQL的存储引擎是插件式的，不同的存储引擎支持不同的特性，可以为不同的表选择不同的引擎

```mysql
# 查看MySQL支持哪些存储引擎
show engines;

# 查看默认存储引擎
show variables like '%storage_engine%';

# 查看某张表的存储引擎
select engine from information_schema.tables
where table_schema = '$db'
and table_name = '$table';
```

MySQL当前默认的存储引擎是InnoDB，并且在5.7版本所有的存储引擎中只有InnoDB是事务性存储引擎，也就是说只有InnoDB支持事务

### MyISAM



### InnoDB

### Memory



## 磁盘IO原理

## 数据页格式

## 索引

